h1. Data abstractions

This document describes abstractions available for TAO 3.0. Please see [[Data abstractions 2.6]] for TAO 2.6.

{{>toc}}

There are currently 5 distinct storages that are used during the delivery:

h2. Result storage abstraction

The choice of a Result Storage implementation is done by configuring a Result Server. Each delivery is configured with one result server. 
This happens in the back office user interface respectively in "Result Servers Management" and "Delivery" tabs. 

Two major implementations of result Storage exist: 
#  taoResults
#  keyValueResultStorage 


The KeyValue Result storage implementation may be installed and configured under the following conditions: 
* If you are using Ubuntu, make sure you have the following packages installed:
** for Redis:
"redis-server" (on the server you want to use for the storage) 
"php5-redis" on the TAO application server
** for Couchbase:
"couchbase-server" (on the server you want to use for the storage)
PECL "couchbase" library on the TAO application server

* You have the *taoAltResultStorage* extension installed. See [[Installing a new extension]] or follow the following instructions:
** Download and install the taoAltResultStorage extension found "here":https://github.com/oat-sa/extension-tao-outcomekeyvalue/releases/tag/v1.0. Unzip the contents of this, and rename the _extension-tao-outcomekeyvalue-1.0_ folder to _taoAltResultStorage_. Place this renamed folder in the web root of the TAO app. Then add this line to the _vendor/composer/autoload_psr4.php_ file:
<pre><code class="php">'oat\\taoAltResultStorage\\' => array($baseDir . '/taoAltResultStorage'),</code></pre>
** In the extension manager, install the extension called taoAltResultStorage. If you switch to the tab called "Manage Result Server", you will be able to see a new result Server called KeyValueResults. 


If you have chosen to use a remote Redis server or wanted to have Redis running on a different port than the default one (6379). You may edit the configuration file _config/generis/persistences.config.php_.:
* For Redis:
<pre><code class="php">
'keyValueResult' => array(
	    'driver' => 'phpredis',
        'host' => '127.0.0.1',
        'port' => 6379
	)</code></pre>
* For Couchbase:
<pre><code class="php">
'keyValueResult' => array(
	    'driver' => 'couchbase',
        'cluster' => 'couchbase://localhost',
        'bucket' => 'your_tao_bucket',
        'password' => 'your_tao_bucket_password' //optional
	)</code></pre>

* When you configure a delivery, you may now decide to send the results to the Redis server, choose the option _KeyValueResultStorage_ in the delivery configuration tool.

h2. Service state storage abstraction

The service state storage manages the state of any service that has been started. This can include among many the states of items (selected responses), states of the test (current item) and state of the delivery. This is always stored in the key-value persistence identified by *'serviceState'*.

h3. Storing service states in the filesystem (default)

The default persistence is defined in _config/generis/persistences.conf.php_ and will store the state of the services in the directory _data/generis/serviceState_.

<pre><code class="php">'serviceState' => array(
    'driver' => 'phpfile',
)</code></pre>

h3. Storing service states in a Redis or Couchbase server

If you prefer to store these states in an alternative storage, edit the file _config/generis/persistences.conf.php_ and modify the 'serviceState' entry to the following:
* for Redis:
<pre><code class="php">'serviceState' => array(
    'driver' => 'phpredis',
    'host' => '127.0.0.1',
    'port' => 6379
)</code></pre>

* for Couchbase:
<pre><code class="php">'serviceState' => array(
     'driver' => 'couchbase',
     'cluster' => 'couchbase://localhost',
     'bucket' => 'your_tao_bucket',
     'password' => 'your_tao_bucket_password' //optional
)</code></pre>

h2. Delivery execution informations storage abstraction

Delivery execution information cover everything related to what test taker has started/finished which delivery. The choice of the abstraction is done in _config/taoDelivery/execution_service.conf.php_.

h3. Storing delivery execution informations in the ontology (default)

<pre><code class="php">
return new taoDelivery_models_classes_execution_OntologyService();
</code></pre>

h3. Storing delivery execution informations in a key-value server 

To switch to a KeyValue persistence we need to first change the service to _taoDelivery_models_classes_execution_KeyValueService_ in _config/taoDelivery/execution_service.conf.php_:
<pre><code class="php">
return new taoDelivery_models_classes_execution_KeyValueService(array('persistence' => 'deliveryExecution'));
</code></pre>

Additionally the persistence used by the key value service needs to be defined in _config/generis/persistences.conf.php_. 

If you would like to use Redis you would add the following block:
<pre><code class="php">'deliveryExecution' => array(
    'driver' => 'phpredis',
    'host' => '127.0.0.1',
    'port' => 6379
)</code></pre>

If you would like to use Couchbase you would add the following block:
<pre><code class="php">'deliveryExecution' => array(
    'driver' => 'couchbase',
    'cluster' => 'couchbase://localhost',
    'bucket' => 'your_tao_bucket',
    'password' => 'your_tao_bucket_password' //optional
)</code></pre>

h2. PHP session storage abstraction

This abstraction allows to use user-level session storage, for storing and retrieving data associated with a session.
See also: http://php.net/manual/en/function.session-set-save-handler.php

h3. System session storage (default)

By default the PHP environment will handle all session storage and retrieval on a system-level.

h3. Storing the session in a key-value server

To use the key-value storage for the php session change the service used in _config/tao/session.conf.php_: 

<pre><code class="php">
return new common_session_php_KeyValueSessionHandler(array(
    common_session_php_KeyValueSessionHandler::OPTION_PERSISTENCE => 'session'
));
</code></pre>

The persistence used for the session needs to be defined in _config/generis/persistences.conf.php_:

* If you wish to use Redis add the following persistence:
<pre><code class="php">'session' => array(
    'driver' => 'phpredis',
    'host' => '127.0.0.1',
    'port' => 6379
)</code></pre>

* If you wish to use Couchbase add the following persistence:
<pre><code class="php">'session' => array(
    'driver' => 'phpredis',
    'cluster' => 'couchbase://localhost',
    'bucket' => 'your_tao_bucket',
    'password' => 'your_tao_bucket_password' //optional
)</code></pre>

h2. URI provider

The URI provider is used to generate new URIs for newly created resources. If multiple application servers are used for delivering tests in Tao these application servers need to ensure that they don't generate conflicting URIs and therefore should use a common URI provider.

h3. Using the SQL server as URI provider (default)

By default Generis uses the SQL database to generate new URIs:
<pre><code class="php">
return new core_kernel_uri_DatabaseSerialUriProvider(array('persistence' => 'default','namespace' => LOCAL_NAMESPACE.'#'));
</code></pre>

h3. Using the key-value server as URI provider

To switch to a the advanced key-value implementation the service in _config/generis/uriProvider.conf.php_ needs to be changed to:
<pre><code class="php">
return new core_kernel_uri_AdvKeyValueUriProvider(array('persistence' => 'uriProvider','namespace' => LOCAL_NAMESPACE.'#'));
</code></pre>

<pre><code class="php">'uriProvider' => array(
    'driver' => 'phpredis',
    'host' => '127.0.0.1',
    'port' => 6379
)</code></pre>
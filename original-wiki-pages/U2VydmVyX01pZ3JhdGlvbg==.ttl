h1. Server Migration

This guide is intended to help you move TAO 3.1 from one server to another without data loss.

For older installations see [[Server Migration 2.5]].

h2. Requirements

* (Optional) Please upgrade to the latest version of TAO first ([[Installation and Upgrading]]).
* This guide assumes you have not heavily modified your configuration. If you are using alternative storage implementations (such as NoSql), the migration might be more complex.

h2. Old Server

* Copy the entire TAO data and config directory from the old server (by default found in config and data).
* Create a dump of the database making sure to include the routines (if you are using mysql, use mysqldump -R).

h2. New Server

h3. File migration

* Replace the config and data directory and to set the correct file owner/rights.
* Modify *config/generis.conf.php* to reflect your new domain and directories. (Do NOT change GENERIS_INSTANCE_NAME or LOCAL_NAMESPACE.)
* watch out for the trailing slashes when writing paths !
<pre>
define('ROOT_PATH','/var/www/newTaoDirectory/');
define('ROOT_URL','http://www.newTaoDomain.com/');
.
.
define('FILES_PATH','/opt/newTaoDataDirectory/');
</pre>


* Modify *config/generis/persistences.conf.php* to reflect your new database configuration.
<pre>'default' => array(
    'driver' => 'pdo_mysql',
    'host' => 'localhost',
    'dbname' => 'DbName',
    'user' => 'DbUserName',
    'password' => 'DbPassword',
),</pre>
* Update the directory *path* value in *config/tao/websource_[CODE].conf.php* to point to your new TAO data directory. (Do NOT modify *fsUri*.)
<pre>return array(
    'className' => 'oat\\tao\\model\\websource\\TokenWebSource',
    'options' => array(
        'secret' => 'a0c2ef52398c24d5347109f930d907d3',
        'path' => '/opt/newTaoDataDirectory/tao/public/',
        'ttl' => 1440,
        'fsUri' => 'http://YOUR_LOCAL_NAMESPACE#i1231456789',
        'id' => '55a53f75bf715',
    ),
);</pre>

h3. Database migration

* Import the SQL dump into the new database
* Update the file sources, this can either be done line by line or all in one go:
<pre>
UPDATE statements SET object = REPLACE (`object`, 'OLD_FILES_PATH', 'NEW_FILES_PATH') where object like 'OLD_FILES_PATH%';
</pre>
An example, assuming your old data was stored in */var/www/tao/data/* and your new environment will store its data in */opt/taoData/* would be:
<pre>
UPDATE statements SET object = REPLACE (`object`, '/var/www/tao/data/', '/opt/taoData/') where object like '/var/www/tao/data/%';
</pre>

h3. Finally

* (Mandatory) Clear the cache of the file sources by emptying the folder *NEW_FILES_PATH/data/generis/cache/*. This can be achieved using the following command: rm -rf NEW_FILES_PATH/data/generis/cache/*.
* (Optional) Execute *NEW_FILES_PATH/tao/scripts/taoUpdate.php* to ensure all extensions are up to date and to regenerate the translation files